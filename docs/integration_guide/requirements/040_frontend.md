
# 4. 機能要件（ユーザー向け）

## 4.1 アカウント・認証

### 4.1.1 サインアップ

**目的**
ユーザーを一意に識別し、プラン情報（無料/有料）を紐づける。

**入力項目（クライアント側）**

* `email`（必須）

  * 形式チェック（`xxx@yyy.zz`）
* `password`（必須）

  * 8文字以上
  * 英字＋数字を含むことを推奨（強度チェックはクライアントで簡易表示）
* `agree_terms`（必須）

  * 利用規約・プライバシーポリシーへの同意チェックボックス

**画面挙動**

1. 入力フォームでバリデーション（未入力・形式不正の場合はその場でエラー表示）
2. `Sign Up` ボタン押下 → バックエンドAPIへPOST
3. 成功時：

   * アクセストークンを受信 → 端末に安全に保存（SecureStorage 等）
   * そのままログイン状態でホーム画面へ遷移
4. 失敗時：

   * すでに登録済みメール → 「このメールアドレスはすでに登録されています」
   * その他サーバーエラー → 汎用エラー表示

**想定API**

```http
POST /auth/signup
Body: { email, password }
Response: { user_id, access_token, plan_type }
```

---

### 4.1.2 ログイン

**入力**

* `email`
* `password`

**挙動**

1. フォームに入力 → バリデーション
2. APIに送信
3. 成功時：`access_token` を更新し、ホーム画面へ
4. 失敗時：認証エラーの場合は「メールアドレスまたはパスワードが違います」と表示

**セッション仕様**

* `access_token` は有効期限付き（例：数日〜数週間）
* アプリ起動時にトークンが有効なら、自動ログイン（ログイン画面スキップ）

---

### 4.1.3 プラン管理（フロント側）

**目的**

* 無料 / 有料で UI や機能を出し分ける。

**表示ロジック**

* `plan_type` が `free` の場合：

  * 銘柄追加画面で「残り登録可能数」を表示（例：`4/6銘柄登録中`）
  * アラート条件の編集項目を非活性（±5%固定表示）
  * 「有料プランでカスタマイズ可能」というラベルを表示
* `plan_type` が `paid` の場合：

  * 登録数上限表示なし（内部制限はサーバー側で管理）
  * アラート条件の入力UIを有効化

---

## 4.2 銘柄登録

### 4.2.1 銘柄一覧画面（ホーム）

**表示内容**

* 各銘柄ごとに表示：

  * 銘柄名（例：`Apple Inc.`）
  * ティッカー（例：`AAPL`）
  * 現在価格（PriceCacheから取得）
  * 基準価格からの変動率（%）
  * アイコン（資産クラス別の簡易アイコン）

**ユーザー操作**

* 「＋ 銘柄を追加」ボタン
* 各銘柄をタップ → 詳細・設定画面へ

---

### 4.2.2 銘柄追加フロー

1. ホームで「＋ 銘柄を追加」をタップ
2. 資産クラス選択モーダルを表示

   * `株式 / 仮想通貨 / FX / 金・原油 / 指数`
3. 資産クラスを選択すると、検索画面へ遷移

**検索画面仕様**

* 入力欄：`ティッカー or 名称`
* 入力のたびにAPIを叩くのではなく、一定文字数（2〜3文字）入力後に検索ボタン押下にする（APIコール抑制）
* 検索結果リスト表示：

  * `銘柄名`
  * `ティッカー`
  * `取引所/市場`（あれば）

**想定API**

```http
GET /assets/search?class=stock&query=AAP
Response: [{ asset_id, asset_class, ticker, name, exchange }]
```

**追加時の挙動**

1. 検索結果から銘柄をタップ
2. バックエンドから現在価格を取得（キャッシュ利用）

```http
GET /prices/current?asset_id=xxx
Response: { price, currency, price_at }
```

3. 「基準価格設定」画面を表示

   * 入力欄：`基準価格`
   * 初期値：APIから取得した `price`
   * 任意でユーザーが編集可能（自分の取得単価に合わせる）
4. 保存ボタン押下 → ユーザー銘柄設定APIへ

```http
POST /user/assets
Body: { asset_id, base_price, alert_up_pct, alert_down_pct }
```

※無料プランでは `alert_up_pct`, `alert_down_pct` はサーバー側で `5` に上書きしてもよい。

---

### 4.2.3 銘柄数制限（無料プラン）

**画面側制御**

* `plan_type = free` かつ `登録済み銘柄数 >= 6` の場合：

  * 「＋ 銘柄を追加」ボタンを押したら

    * モーダルで「無料プランでは6銘柄までです。有料プランで上限解除できます」と表示
    * 有料プラン案内画面へのリンクボタンを配置

**サーバー側制御**

* API側でも `user_id` ごとの登録銘柄数をチェックし、上限超過時はエラーを返す
  （クライアント側改変を防ぐ）

---

## 4.3 アラート条件の設定

### 4.3.1 無料プランの仕様（固定条件）

**ユーザー操作**

* 銘柄詳細画面で「アラート設定」を開く
* 表示項目：

  * 「アラート条件：基準値/前回通知値から ±5%以上で通知」
  * 編集は不可（disabled表示）
* 「この条件は無料プランでは固定です」と文言を表示

**サーバー側仕様**

* 無料ユーザーの `alert_up_pct`, `alert_down_pct` は `5` で固定
  （リクエスト側で変更されても無視）

---

### 4.3.2 有料プランの仕様（カスタマイズ可能）

**設定画面UI**

* 入力項目：

  * 上昇側しきい値 `alert_up_pct`（例：`5`）
  * 下落側しきい値 `alert_down_pct`（例：`3`）
* 入力形式：

  * スライダー or 数値入力（1〜50%程度まで）
  * 仮想通貨の場合はプリセットボタン（`5%`, `10%`, `15%`）など
* 値域バリデーション：

  * 最小：1%
  * 最大：50%（FXは2〜5%などもう少し狭める選択肢もあり）

**保存処理**

```http
PUT /user/assets/{user_asset_id}/alert
Body: { alert_up_pct, alert_down_pct }
```

**補足**

* 資産クラスに応じた初期値を出す（株：±5%、仮想通貨：±10% 等）
* 入力値が極端（例：0.1%など）な場合はクライアント側で警告を出す
  → 過剰通知によるアンインストールを防ぐ

---

## 4.4 定期チェック & 通知ロジック（ユーザー視点）

これはバックエンド側の処理だが、ユーザーから見える挙動として仕様化しておく。

### 4.4.1 チェック頻度と監視時間（ユーザーに見える仕様）

* 無料プラン：

  * 監視時間：**8:00〜24:00（JST）**
  * チェック頻度：**4時間ごと**
    → 8:00 / 12:00 / 16:00 / 20:00 / 24:00
* 有料プラン：

  * 監視時間：**24時間**
  * チェック頻度：**1〜2時間ごと**（ここは実装時に固定値を決める）

**ユーザーへの説明**

* 設定画面 or ヘルプに以下を明記：

  * 「無料プランでは4時間ごとに価格をチェックします（8:00〜24:00）。」
  * 「有料プランでは24時間、1〜2時間ごとにチェックします。」

---

### 4.4.2 通知条件（ユーザーから見えるルール）

* 共通ルール：

  * **基準価格 or 前回通知価格からの変動率**で判定
* 通知条件例：

  * 「基準価格から +5% を超えたとき」
  * 「前回通知から -10% を超えたとき」

**ユーザーに見せる説明例**

* 銘柄詳細画面に説明文：

  * 「アラートは、基準価格または前回通知からの変動率がしきい値を超えたタイミングで1回だけ送信されます。」

---

### 4.4.3 通知連打防止（ユーザー視点）

**仕様**

* 同じ銘柄が**短時間に何度も通知されることを避ける**
* 具体的挙動（例）：

  * 基準値 100円、しきい値 ±5% の場合
    → 105円到達で1回通知
    → そのあと 106, 107, 108 円になっても通知しない
    → 110円を超えたタイミングで再度通知、など
* 仮想通貨などボラの大きい資産：

  * 一度通知してから、**一定時間（例：30分〜1時間）は通知を抑制**する

**ユーザーへの説明**

* 通知が来すぎないよう、「一定の間隔をあけて通知しています」とヘルプに記載

---

## 4.5 通知表示

### 4.5.1 プッシュ通知内容

**タイトル例**

* 「AAPL が -5.2% 下落しました」
* 「BTC が +10.3% 上昇しました」

**本文例**

* 「基準値：150.00 USD → 現在値：142.20 USD」
* 「前回通知からの変動：+11.0%」

**言語**

* MVPでは日本語固定でOK（英語対応は後回し）

---

### 4.5.2 通知タップ後の画面

**遷移先**

* 銘柄詳細画面

**表示項目**

* 銘柄名＋ティッカー
* 現在価格
* 基準価格
* 変動率（基準値 / 前回通知値に対する）
* 最後に通知した日時
* アラート条件（±X%）

**操作**

* 「アラート条件を変更」ボタン（有料ユーザーのみ）
* 「この銘柄を削除」ボタン

---

## 4.6 スクショ一括インポート（オプション機能）

### 4.6.1 入口

* ホーム画面 or 設定画面に「スクショから一括登録」ボタンを配置

### 4.6.2 フロー概要

1. 「スクショから一括登録」をタップ
2. 端末の画像選択画面（カメラロール）を開く
3. ユーザーが証券アプリの保有銘柄一覧のスクショを選択
4. サーバーに画像アップロード → Vision APIで解析
5. 解析結果をリスト表示

   * 推定された銘柄名・ティッカー・取得単価・評価額など
6. ユーザーが

   * 登録する銘柄をチェック
   * 基準価格（取得単価）を必要に応じて修正
7. 一括保存 → 銘柄一覧に追加

---

### 4.6.3 プライバシー表示

**画面上の明示**

* 「アップロードした画像は、解析後すぐにサーバーから削除されます」
* 「名前・口座番号などの個人情報は解析対象から除外します」

**マスク処理**

* クライアント or サーバー側で、画面上部数十ピクセルを自動マスク（名前・口座番号が写りがちなエリア）

---

### 4.6.4 プランによる制限

* 無料プラン：

  * 月1〜2回まで
* 有料プラン：

  * 制限を緩く（例：月10回 or 実質無制限）

**UI**

* 使用回数を表示（例：`今月のスクショ登録：1/2回`）
* 上限超過時は「今月の無料枠は上限に達しました」のモーダルを出す

---

## 4.7 通知履歴（簡易ログ）

### 4.7.1 一覧画面

**表示位置**

* タブ or メニューで「通知履歴」画面を用意

**表示項目（1行）**

* 通知日時
* 銘柄アイコン（資産クラス別）
* ティッカー
* 変動率（`+10.2%` など）

例：
`2025/12/02 14:00  |  AAPL  |  -5.3%`

**操作**

* 行タップ → 対象銘柄の詳細画面へ遷移
* 「すべて削除」ボタン（ローカルキャッシュ削除）

---

### 4.7.2 保持期間

**サーバー側**

* 通知ログは、分析用に90日程度保持（設計は5章で詳細化）

**クライアント側**

* 表示対象は過去30日分程度（スクロールで見れる）

**UIの期待値**

* 古いものは自然に消えていくが、特にユーザーに対しては明示不要
  → 「最近の通知を確認する」用途に絞る
