# 6. プラン・制限仕様

本アプリは、**無料プラン**と**有料プラン（サブスク）**の2階層構成とする。
ここでは、「どのユーザーがどこまで使えるか」を決める**ルールそのもの**を定義する。

---

## 6.1 プラン種別

* `free`：無料プラン
* `paid`：有料サブスクプラン（名称は仮：**Proプラン**）

バックエンドでは、`Users.plan_type` として管理する。

---

## 6.2 無料プラン（free）

### 6.2.1 概要

* 想定ユーザー：

  * お試しユーザー / ライト投資家
* 目的：

  * 「このアプリで何ができるか」を体験させる
  * サーバー・APIコストを抑えつつ、ユーザーベースを増やす

### 6.2.2 無料プランでできること

1. **銘柄登録数**

   * 上限：**6銘柄**
   * 資産クラス（株・仮想通貨・FX・金・指数）は混在OK
   * 7銘柄目を登録しようとした場合：

     * フロント：モーダル表示で「無料プランは6銘柄まで」と案内
     * バックエンド：`POST /user/assets` で上限超過時にエラーを返す

2. **監視時間**

   * 監視対象時間：**8:00〜24:00（JST）**
   * この時間帯のみ、価格チェック＆アラート判定ジョブの対象となる

3. **チェック間隔**

   * 価格チェック：**4時間おき**

     * 実行タイミング例：8:00 / 12:00 / 16:00 / 20:00 / 24:00
   * 無料ユーザーのアラート判定は、このタイミングでのみ行われる

4. **アラート条件**

   * 上昇・下落ともに **±5% 固定**
   * ユーザーはしきい値を変更できない
   * 判定基準：

     * 基準価格 or 前回通知価格 から ±5% を超えた場合に通知候補に乗る
   * バックエンド側では、`alert_up_pct` / `alert_down_pct` に何が入っていても **5% として扱う** 実装でよい

5. **スクショ一括インポート**

   * 利用回数制限：**月1〜2回程度**（正確な数値は後で調整可能）
   * 仕様：

     * 月ごとのカウンタをユーザー単位で持つ（例：`UserScreenshotUsage` 的なテーブル）
     * 上限到達時：

       * フロント：モーダルで「今月の無料枠は上限に達しました」と表示
       * バックエンド：上限超過時にエラー返却

6. **通知履歴**

   * 無料／有料で機能差はつけない（同じUI）

---

## 6.3 有料プラン（paid / Pro）

### 6.3.1 概要

* 課金形式：

  * 月額サブスク（例：**480〜580円/月**）
  * App Store / Google Play のサブスクリプションを利用
* 想定ユーザー：

  * 10銘柄以上を監視したい中級投資家
  * 仮想通貨やFXもガッツリ持っていて、「感度を調整したい」層

### 6.3.2 有料プランでできること

1. **銘柄登録数**

   * 上限：**実質無制限**
   * ただし、システム保護のため内部的にはソフトリミット（例：500銘柄）を持つことを推奨

     * 超過時：

       * バックエンド：エラー返却
       * フロント：「登録数が上限を超えました」の警告表示
   * 仕様書上は以下のように記載：

     * 「ユーザーに対する表示上は“上限なし”だが、内部設計としては数百銘柄程度に制限を設ける可能性がある」

2. **監視時間**

   * **24時間監視**
   * 深夜〜早朝も含め、全時間帯で価格チェック＆アラート判定の対象
   * FX・仮想通貨のような24時間市場をフルにカバー

3. **チェック間隔**

   * 価格チェック：**1〜2時間おき**

     * 実装ではどちらかに固定する（例：2時間ごと）
   * 例（2時間ごとなら）：0:00 / 2:00 / 4:00 / … / 22:00
   * 無料ユーザーよりも2〜4倍頻度が多い

4. **アラート条件（カスタマイズ）**

   * ユーザーごとに銘柄単位で以下を設定可能：

     * 上昇側しきい値：`alert_up_pct`（例：+3%）
     * 下落側しきい値：`alert_down_pct`（例：-7%）
   * 入力制限：

     * 最小：1%
     * 最大：50%（資産クラスによってフロントのUIで推奨範囲を変えるのはOK）
   * 資産クラスごとのデフォルト値：

     * 株：±5%
     * 仮想通貨：±10%
     * FX：±2%
   * 有料プランの価値：

     * 「銘柄ごとに」「上昇・下落別」に**感度を細かく調整**できる

5. **スクショ一括インポート**

   * 無料よりも利用制限を緩く：

     * 例：**月10回** もしくは **上限なし**
   * 価格APIコストに直結しない機能なので、そこまで厳密に制限しなくてよい

6. **仮想通貨などボラが激しい資産のクールダウン**

   * 通知を連打しないための特別ルールを有効化：

     * 一度通知したら、**一定時間（例：30〜60分）は同銘柄の通知を抑制**
   * これは無料／有料どちらにも適用して良いが、有料ユーザーを優先して最適化する

---

## 6.4 プラン差分の一覧（実装・テスト用まとめ）

| 項目           | 無料プラン (`free`)       | 有料プラン (`paid`)        |
| ------------ | -------------------- | --------------------- |
| 月額料金         | 0円                   | 例：480〜580円            |
| 銘柄登録数        | 最大 6 銘柄              | 実質無制限（内部ソフトリミットあり）    |
| 監視時間         | 8:00〜24:00（JST）      | 24時間                  |
| チェック間隔       | 4時間ごと                | 1〜2時間ごと               |
| アラートしきい値     | ±5% 固定               | ユーザーが上下別々に設定可         |
| 資産クラスごとの感度調整 | なし                   | あり（株/仮想通貨/FXなどで変えられる） |
| スクショ一括インポート  | 月1〜2回                | 月10回 or 実質無制限         |
| 通知クールダウン     | 有り（仮想通貨などで適用）        | 同様（必要に応じて調整）          |
| UIの表示        | 設定項目は最小限・一部グレーアウト／固定 | すべてのアラート設定UIが有効       |

---

## 6.5 プランの状態遷移（ルール）

### 6.5.1 新規ユーザー

* 初期状態：`plan_type = "free"`
* 無料プランの制限が即時適用される

### 6.5.2 無料 → 有料へのアップグレード

1. ユーザーがアプリ内で「有料プランにアップグレード」を選択
2. ストアのサブスク購入フローへ遷移（App Store / Google Play）
3. 購入完了後：

   * クライアントがレシートを `POST /subscriptions/verify` に送信
   * サーバーで検証 → OKなら

     * `Users.plan_type = "paid"`
     * `Users.plan_expiry = 検証結果の有効期限`
4. フロントエンド：

   * 銘柄数の上限表示を消す
   * アラート条件編集UIを有効化
   * 有料プランバッジを表示（任意）

### 6.5.3 有料 → 無料へのダウングレード

* パターン1：ユーザーがストアのサブスクを解約
* パターン2：有効期限切れ

サーバー側ロジック：

* `plan_expiry` を超えたタイミングで：

  * 認証時 or バッチで `plan_type` を `free` に戻す
* 戻した際の扱い：

  * **既に登録されている銘柄は削除しない**

    * ただし「監視されるのは先頭6件のみ」とするか、
    * あるいは一時的にアラート判定対象から外すか、どちらかの仕様を選ぶ必要がある

おすすめ仕様：

* 無料に戻った時点で：

  * 登録銘柄は残すが、
  * **アラート判定対象は「登録日時の古い6件」だけ** にする
  * フロント側で

    * 「無料プランでは6銘柄まで監視されます。それ以外の銘柄はアラート対象外です」
      をバナー表示

---

## 6.6 制限と保護ルール（サーバー・コスト観点）

### 6.6.1 ユーザー単位の制限

* 最大登録銘柄数（有料含む）：

  * 現実的な上限（例：500銘柄）をサーバー側に設置
* スクショ解析の上限：

  * 月ごとの利用カウントで制御（無料/有料で別枠）

### 6.6.2 APIコールの保護

* ユニーク銘柄数が増えすぎた場合：

  * 新規銘柄登録の際に「この銘柄は現在サポート対象外です」と返す方針に切り替え可能
* 一時的に外部APIが高負荷 or 制限超過の場合：

  * その回のアラート判定をスキップ
  * ログとアラート（開発者向け）

---

## 6.7 将来的なプラン拡張（メモ）

仕様書には直接含めなくてもいいが、設計上「増やせる」ことを前提にする。

* 例：

  * `Pro+` プラン：チェック間隔を1時間、スクショ解析無制限など
  * `Crypto専用プラン`：仮想通貨のみ監視する安価プラン

→ バックエンド側では `plan_type` を `free` / `pro` / `pro_plus` のように拡張できるようにしておく。

