# 3. 対象資産（監視対象）

このアプリが監視できる資産クラス・銘柄・データソースを明確化する。
実装に必要な **APIカバレッジ / データ構造 / 更新頻度 / 制約** を含めた仕様として定義する。

---

## 3.1 監視対象の資産クラス（固定仕様）

アプリが最初に対応する資産クラスは以下の5種類。

1. **株式（Stocks）**
2. **仮想通貨（Crypto Assets）**
3. **FX（Foreign Exchange）**
4. **コモディティ（Commodities）**
5. **株価指数・ETF（Indices / ETFs）**

※MVPのため、資産クラスは **ユーザーが追加できる項目** としてではなく、
クライアント側で固定メニューとして表示する。

---

## 3.2 データソース（使用API）と制約

### 3.2.1 株式（米国株）

* **API**：Marketstack（Basicプラン想定）
* **データ遅延**：最大15〜30分遅延（API仕様）
* **価格取得**：終値 or 直近ティック（APIエンドポイントに依存）
* **ティッカー形式**：`AAPL`, `MSFT`, `TSLA` など
* **対象銘柄数**：S&P500 主要銘柄を中心にカバー
  → Marketstack Basic は **呼び出し数制限があるため、ユニーク銘柄数が増えたら上位プラン検討**

### 3.2.2 日本株

* **API**：Marketstack or 他の無料/安価API（候補：Yahoo Finance非公式 → 商用利用不可）
* **制約**：商用で提供可能な日本株APIは有料が多い
* **方針（MVP）**：

  * 日本株は「主要銘柄（TOPIX Core30 程度）」に限定
  * ユーザー検索は「登録された日本株マスタからの検索」に制約する
* **ティッカー形式**：`7203.T`（トヨタ）など

### 3.2.3 仮想通貨

* **API**：CoinGecko
  → **商用利用可能 & 無料**（レート制限あり）
* **価格取得**：USD建 or JPY建を選べる
* **対象銘柄数**：BTC / ETH / SOL / XRPなど主要銘柄（トップ100程度まで対応可能）
* **リアルタイム性**：API更新頻度20秒〜2分（十分高い）

### 3.2.4 FX（主要通貨）

* **API**：無料FXレートAPI（例：ExchangeRate API、OpenER API）
* **通貨ペア形式**：`USD/JPY`, `EUR/USD`, `GBP/JPY`
* **対象ペア**：主要10通貨ペア程度
* **更新頻度**：1〜2分更新（実用的）

### 3.2.5 コモディティ（金・原油）

* **API**：Marketstack または 金/原油価格API（無料のもの多数）
* **対象銘柄**：

  * Gold Spot (`XAU/USD`)
  * WTI原油 (`CL=F` 等)
* **リアルタイム性**：数分遅延は許容

---

## 3.3 銘柄マスタ（AssetMaster）の仕様

データベース側で管理する銘柄情報は以下を基本フィールドとする：

| フィールド名      | 型             | 説明                                            |
| ----------- | ------------- | --------------------------------------------- |
| id          | string (UUID) | 銘柄ID                                          |
| asset_class | enum          | `stock`, `crypto`, `fx`, `commodity`, `index` |
| ticker      | string        | `AAPL`, `BTC`, `USD/JPY`, `XAU/USD` など        |
| name        | string        | 銘柄名（フル名称）                                     |
| exchange    | string        | 取引所（株式用／仮想通貨は取引所不要）                           |
| currency    | string        | 価格通貨（USD/JPYなど）                               |
| enabled     | bool          | 監視対象として有効かどうか                                 |

### 実装上のポイント

1. **検索を高速化するために、ticker + name にインデックスを貼る**
2. **ユーザーが検索してもヒットしない銘柄は非対応として扱う**
3. **API上存在する銘柄でも、検証未済のものは enabled=false にして検索対象外**

---

## 3.4 価格取得仕様（PriceCache）

### 3.4.1 バッチ側で保持するデータ

| フィールド名   | 説明                            |
| -------- | ----------------------------- |
| asset_id | AssetMaster.id                |
| price    | 現在価格                          |
| price_at | API取得時刻                       |
| provider | API名（Marketstack/CoinGeckoなど） |

### 3.4.2 設計意図

* ユーザー側で「毎回APIを叩く」方式は採用しない
  → **コスト爆増**のため
* バッチが一括で取得してキャッシュする
  → ユーザーの閲覧・判定はすべてこのキャッシュを参照

---

## 3.5 資産クラス別の更新頻度（内部仕様）

| 資産クラス  | 無料プラン | 有料プラン | 実際のAPI更新速度 |
| ------ | ----- | ----- | ---------- |
| 米株     | 4h    | 1–2h  | 15–30分遅延   |
| 日本株    | 4h    | 1–2h  | 最大数十分遅延    |
| 仮想通貨   | 4h    | 1–2h  | 1–2分       |
| FX     | 4h    | 1–2h  | 1分前後       |
| コモディティ | 4h    | 1–2h  | 数分         |

※有料プランでも「1分間隔・10秒間隔」などは実現しない（デイトレ層をターゲット外とするため）

---

## 3.6 資産クラス別：アラート設計の条件差

| 資産クラス    | 推奨デフォルト（無料/有料共通） | 備考                     |
| -------- | ---------------- | ---------------------- |
| 株（米国・日本） | ±5%              | 前日比で5%超は重要イベント級        |
| 仮想通貨     | ±10%             | ボラが大きいため過剰通知を避ける       |
| FX       | ±1〜2%            | 通常は数％動けば異常値            |
| コモディティ   | ±5%              | 日によっては2〜3%も大きいが、シンプル優先 |
| 株価指数     | ±3%              | 指数は個別株より安定             |

---

## 3.7 後続機能に影響する事項（実装判断ポイント）

### ◆ ① APIごとに価格の遅延が違う

→ 通知メッセージには「遅延あり」の文言は入れない（UX低下のため）
→ ただし、内部では price_at で扱いを統一

### ◆ ② 日本株はAPI事情により「広すぎる検索範囲」を実現しない

→ ユーザーが JP株を検索したとき、
ヒットしない場合は **「現在この銘柄には対応していません」** と表示

### ◆ ③ FX・仮想通貨は24時間市場だが、無料プランは 8:00–24:00 のみ監視

→ この仕様はターゲット層の行動に合わせたもの
→ 実装では user_plan に応じて監視スケジュールを切る

### ◆ ④ major / minor 通貨や obscure な仮想通貨は除外

→ マスタ管理が破綻するため
→ 原則「上位100銘柄」程度を対象

---

## 3.8 MVP段階の対象範囲（確定値）

**最初のリリースに入れる対象範囲（固定）：**

* 株（米国）
  → AAPL, MSFT, TSLA, NVDA, AMZN, META など主要S&P500銘柄中心
* 仮想通貨
  → BTC, ETH, SOL, XRP, DOGE 他トップ30
* FX
  → USD/JPY・EUR/USD・GBP/USD・EUR/JPY
* コモディティ
  → Gold Spot, WTI原油
* 株価指数
  → S&P500・NASDAQ100

日本株：
→ Core30 程度に限定
→ ユーザー検索時にヒットする範囲を明確に定義する
